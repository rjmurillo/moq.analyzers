<Project>
  <!--
    Automatically configure git to use .githooks/ as the hooks directory.
    Runs once per clone via sentinel file. Degrades gracefully in CI or non-git contexts.
  -->
  <Target
    Name="ConfigureGitHooks"
    BeforeTargets="Restore;Build"
    Condition=" '$(DesignTimeBuild)' != 'true' AND '$(ContinuousIntegrationBuild)' != 'true' AND Exists('$(RepoRoot).git') AND !Exists('$(RepoRoot).git/hooks/.githooks-configured') ">

    <Exec
      Command="git config core.hooksPath .githooks"
      WorkingDirectory="$(RepoRoot)"
      IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="_GitHooksExitCode" />
    </Exec>

    <Touch
      Condition=" '$(_GitHooksExitCode)' == '0' "
      Files="$(RepoRoot).git/hooks/.githooks-configured"
      AlwaysCreate="true" />

    <Message
      Condition=" '$(_GitHooksExitCode)' == '0' "
      Importance="high"
      Text="Git hooks configured. Run 'git config --unset core.hooksPath' to disable." />

    <Warning
      Condition=" '$(_GitHooksExitCode)' != '0' "
      Text="Failed to configure git hooks (exit code $(_GitHooksExitCode)). Run 'git config core.hooksPath .githooks' manually." />
  </Target>
</Project>

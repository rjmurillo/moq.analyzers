# Moq1003: Internal type requires InternalsVisibleTo for DynamicProxy

| Item     | Value   |
| -------- | ------- |
| Enabled  | True    |
| Severity | Warning |
| CodeFix  | False   |

---

When mocking an `internal` type with `Mock<T>`, Castle DynamicProxy needs access to the type's internals to generate a proxy at runtime. Without `[InternalsVisibleTo("DynamicProxyGenAssembly2")]` on the assembly containing the internal type, the mock will fail at runtime.

To fix:

- Add `[assembly: InternalsVisibleTo("DynamicProxyGenAssembly2")]` to the assembly containing the internal type
- Make the type `public` if appropriate
- Introduce a public interface and mock that instead

## Examples of patterns that are flagged by this analyzer

```csharp
// Assembly without InternalsVisibleTo
internal class MyService { }

var mock = new Mock<MyService>(); // Moq1003: Internal type requires InternalsVisibleTo
```

## Solution

```csharp
// Add to AssemblyInfo.cs or any file in the project containing the internal type
[assembly: System.Runtime.CompilerServices.InternalsVisibleTo("DynamicProxyGenAssembly2")]

internal class MyService { }

var mock = new Mock<MyService>(); // OK
```

## Suppress a warning

If you just want to suppress a single violation, add preprocessor directives to
your source file to disable and then re-enable the rule.

```csharp
#pragma warning disable Moq1003
var mock = new Mock<MyService>(); // Moq1003: Internal type requires InternalsVisibleTo
#pragma warning restore Moq1003
```

To disable the rule for a file, folder, or project, set its severity to `none`
in the
[configuration file](https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/configuration-files).

```ini
[*.{cs,vb}]
dotnet_diagnostic.Moq1003.severity = none
```

For more information, see
[How to suppress code analysis warnings](https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/suppress-warnings).
